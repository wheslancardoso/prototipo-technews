<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Comentários - TechNews Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .comment-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .comment-card.pending {
            border-left-color: #ffc107;
            background-color: #fff8e1;
        }
        
        .comment-card.approved {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        
        .comment-card.rejected {
            border-left-color: #dc3545;
            background-color: #fff8f8;
        }
        
        .comment-content {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        
        .filter-tabs {
            border-bottom: 2px solid #e9ecef;
        }
        
        .filter-tab {
            padding: 12px 24px;
            border: none;
            background: none;
            color: #6c757d;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .filter-tab.active {
            color: #495057;
            border-bottom-color: #007bff;
        }
        
        .filter-tab:hover {
            color: #007bff;
        }
        
        .action-buttons .btn {
            margin: 2px;
        }
        
        .bulk-actions {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-newspaper me-2"></i>TechNews Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/articles">
                    <i class="fas fa-file-alt me-1"></i>Artigos
                </a>
                <a class="nav-link active" href="/admin/comments">
                    <i class="fas fa-comments me-1"></i>Comentários
                </a>
                <a class="nav-link" href="/admin/categories">
                    <i class="fas fa-tags me-1"></i>Categorias
                </a>
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Site
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-0">
                    <i class="fas fa-comments me-2"></i>Gerenciar Comentários
                </h1>
                <p class="text-muted">Modere e gerencie comentários dos artigos</p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-comments fa-2x mb-2"></i>
                        <h4 id="total-comments">0</h4>
                        <small>Total de Comentários</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h4 id="pending-comments">0</h4>
                        <small>Aguardando Moderação</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-check fa-2x mb-2"></i>
                        <h4 id="approved-comments">0</h4>
                        <small>Aprovados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-times fa-2x mb-2"></i>
                        <h4 id="rejected-comments">0</h4>
                        <small>Rejeitados</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="search-input" 
                                   placeholder="Buscar por autor, conteúdo ou artigo...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="status-filter">
                            <option value="">Todos os Status</option>
                            <option value="PENDING">Pendentes</option>
                            <option value="APPROVED">Aprovados</option>
                            <option value="REJECTED">Rejeitados</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="sort-filter">
                            <option value="createdAt,desc">Mais Recentes</option>
                            <option value="createdAt,asc">Mais Antigos</option>
                            <option value="authorName,asc">Autor A-Z</option>
                            <option value="authorName,desc">Autor Z-A</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs mb-4">
            <button class="filter-tab active" data-status="">
                <i class="fas fa-list me-1"></i>Todos
            </button>
            <button class="filter-tab" data-status="PENDING">
                <i class="fas fa-clock me-1"></i>Pendentes
            </button>
            <button class="filter-tab" data-status="APPROVED">
                <i class="fas fa-check me-1"></i>Aprovados
            </button>
            <button class="filter-tab" data-status="REJECTED">
                <i class="fas fa-times me-1"></i>Rejeitados
            </button>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selected-count">0</span> comentário(s) selecionado(s)
                </div>
                <div>
                    <button class="btn btn-success btn-sm" id="bulk-approve">
                        <i class="fas fa-check me-1"></i>Aprovar Selecionados
                    </button>
                    <button class="btn btn-danger btn-sm" id="bulk-reject">
                        <i class="fas fa-times me-1"></i>Rejeitar Selecionados
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="clear-selection">
                        <i class="fas fa-times me-1"></i>Limpar Seleção
                    </button>
                </div>
            </div>
        </div>

        <!-- Comments List -->
        <div id="comments-container">
            <!-- Comments will be loaded here -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2 text-muted">Carregando comentários...</p>
        </div>

        <!-- Pagination -->
        <nav aria-label="Paginação de comentários">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>

    <!-- Comment Details Modal -->
    <div class="modal fade" id="commentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Comentário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-content">
                    <!-- Comment details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="modal-approve">
                        <i class="fas fa-check me-1"></i>Aprovar
                    </button>
                    <button type="button" class="btn btn-danger" id="modal-reject">
                        <i class="fas fa-times me-1"></i>Rejeitar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class CommentsAdmin {
            constructor() {
                this.currentPage = 0;
                this.pageSize = 10;
                this.currentStatus = '';
                this.currentSearch = '';
                this.currentSort = 'createdAt,desc';
                this.selectedComments = new Set();
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadComments();
                this.loadStats();
            }

            bindEvents() {
                // Search
                document.getElementById('search-input').addEventListener('input', 
                    this.debounce(() => this.handleSearch(), 500));

                // Filters
                document.getElementById('status-filter').addEventListener('change', () => this.handleStatusFilter());
                document.getElementById('sort-filter').addEventListener('change', () => this.handleSortFilter());

                // Filter tabs
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.handleTabFilter(tab));
                });

                // Bulk actions
                document.getElementById('bulk-approve').addEventListener('click', () => this.bulkApprove());
                document.getElementById('bulk-reject').addEventListener('click', () => this.bulkReject());
                document.getElementById('clear-selection').addEventListener('click', () => this.clearSelection());

                // Modal actions
                document.getElementById('modal-approve').addEventListener('click', () => this.modalApprove());
                document.getElementById('modal-reject').addEventListener('click', () => this.modalReject());
            }

            async loadComments() {
                const loadingEl = document.getElementById('loading-indicator');
                const containerEl = document.getElementById('comments-container');
                
                loadingEl.style.display = 'block';
                containerEl.innerHTML = '';

                try {
                    const params = new URLSearchParams({
                        page: this.currentPage,
                        size: this.pageSize,
                        sort: this.currentSort
                    });

                    if (this.currentStatus) params.append('status', this.currentStatus);
                    if (this.currentSearch) params.append('search', this.currentSearch);

                    const response = await fetch(`/api/admin/comments?${params}`);
                    const data = await response.json();

                    loadingEl.style.display = 'none';
                    this.renderComments(data.content);
                    this.renderPagination(data);
                } catch (error) {
                    console.error('Erro ao carregar comentários:', error);
                    loadingEl.style.display = 'none';
                    containerEl.innerHTML = '<div class="alert alert-danger">Erro ao carregar comentários</div>';
                }
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/admin/comments/stats');
                    const stats = await response.json();

                    document.getElementById('total-comments').textContent = stats.total;
                    document.getElementById('pending-comments').textContent = stats.pending;
                    document.getElementById('approved-comments').textContent = stats.approved;
                    document.getElementById('rejected-comments').textContent = stats.rejected;
                } catch (error) {
                    console.error('Erro ao carregar estatísticas:', error);
                }
            }

            renderComments(comments) {
                const container = document.getElementById('comments-container');
                
                if (comments.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhum comentário encontrado</h5>
                        </div>
                    `;
                    return;
                }

                const commentsHtml = comments.map(comment => this.renderComment(comment)).join('');
                container.innerHTML = commentsHtml;

                // Bind events for new elements
                this.bindCommentEvents();
            }

            renderComment(comment) {
                const statusClass = comment.status.toLowerCase();
                const statusIcon = this.getStatusIcon(comment.status);
                const statusText = this.getStatusText(comment.status);

                return `
                    <div class="card comment-card ${statusClass} mb-3" data-comment-id="${comment.id}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-1">
                                    <input type="checkbox" class="form-check-input comment-checkbox" 
                                           value="${comment.id}" ${this.selectedComments.has(comment.id) ? 'checked' : ''}>
                                </div>
                                <div class="col-md-11">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="mb-1">
                                                <i class="fas fa-user me-1"></i>
                                                ${this.escapeHtml(comment.authorName)}
                                                ${comment.authorWebsite ? `<a href="${comment.authorWebsite}" target="_blank" class="ms-2 text-muted small"><i class="fas fa-external-link-alt"></i></a>` : ''}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-envelope me-1"></i>${comment.authorEmail}
                                                <span class="ms-3">
                                                    <i class="fas fa-clock me-1"></i>${this.formatDate(comment.createdAt)}
                                                </span>
                                            </small>
                                        </div>
                                        <span class="badge bg-${this.getStatusColor(comment.status)}">
                                            ${statusIcon} ${statusText}
                                        </span>
                                    </div>
                                    
                                    <div class="comment-content mb-2">
                                        ${this.escapeHtml(comment.content).replace(/\n/g, '<br>')}
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted small">
                                            <i class="fas fa-file-alt me-1"></i>
                                            Artigo: <strong>${this.escapeHtml(comment.articleTitle)}</strong>
                                            ${comment.parentId ? '<span class="ms-2"><i class="fas fa-reply me-1"></i>Resposta</span>' : ''}
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn btn-outline-primary btn-sm view-comment" 
                                                    data-comment-id="${comment.id}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            ${comment.status === 'PENDING' ? `
                                                <button class="btn btn-success btn-sm approve-comment" 
                                                        data-comment-id="${comment.id}">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm reject-comment" 
                                                        data-comment-id="${comment.id}">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            bindCommentEvents() {
                // Checkboxes
                document.querySelectorAll('.comment-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => this.handleCheckboxChange(checkbox));
                });

                // Action buttons
                document.querySelectorAll('.view-comment').forEach(btn => {
                    btn.addEventListener('click', () => this.viewComment(btn.dataset.commentId));
                });

                document.querySelectorAll('.approve-comment').forEach(btn => {
                    btn.addEventListener('click', () => this.approveComment(btn.dataset.commentId));
                });

                document.querySelectorAll('.reject-comment').forEach(btn => {
                    btn.addEventListener('click', () => this.rejectComment(btn.dataset.commentId));
                });
            }

            // Event handlers and utility methods would continue here...
            // (Additional methods for pagination, filtering, moderation actions, etc.)

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            getStatusIcon(status) {
                const icons = {
                    'PENDING': '<i class="fas fa-clock"></i>',
                    'APPROVED': '<i class="fas fa-check"></i>',
                    'REJECTED': '<i class="fas fa-times"></i>'
                };
                return icons[status] || '';
            }

            getStatusText(status) {
                const texts = {
                    'PENDING': 'Pendente',
                    'APPROVED': 'Aprovado',
                    'REJECTED': 'Rejeitado'
                };
                return texts[status] || status;
            }

            getStatusColor(status) {
                const colors = {
                    'PENDING': 'warning',
                    'APPROVED': 'success',
                    'REJECTED': 'danger'
                };
                return colors[status] || 'secondary';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CommentsAdmin();
        });
    </script>
</body>
</html>